/******/!function(t){function e(i){if(n[i])return n[i].exports;var a=n[i]={exports:{},id:i,loaded:!1};return t[i].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}// webpackBootstrap
/******/
var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";var i=n(1),a=n(2),o=n(3),r=n(4),s=n(5),l=n(6),c=n(7),d=n(8),u=n(9),m=n(10);angular.module("intSmaPerolaDashboard",["ngAnimate","ngCookies","ngTouch","ngSanitize","ngMessages","ngAria","ngRoute","ngMaterial","angular-storage","angular-loading-bar"]).constant("Paho",Paho).constant("moment",moment).config(i.config).config(a.routerConfig).run(o.runBlock).filter("momentFormat",u.momentFormat).service("authenticationService",l.AuthenticationService).service("mqttClientService",c.MqttClientService).service("apiClientService",d.ApiClientService).controller("LoginController",r.LoginController).controller("DashboardController",s.DashboardController).directive("momentFrom",m.MomentFromDirective)},function(t,e){"use strict";function n(t,e,n){"ngInject";t.debugEnabled(!0),e.theme("default").primaryPalette("blue").accentPalette("blue-grey"),n.includeSpinner=!1}n.$inject=["$logProvider","$mdThemingProvider","cfpLoadingBarProvider"],Object.defineProperty(e,"__esModule",{value:!0}),e.config=n},function(t,e){"use strict";function n(t){"ngInject";t.when("/",{templateUrl:"app/login/login.html",controller:"LoginController",controllerAs:"loginCtrl"}).when("/dashboard",{templateUrl:"app/dashboard/dashboard.html",controller:"DashboardController",controllerAs:"dashboardCtrl"}).otherwise({redirectTo:"/"})}n.$inject=["$routeProvider"],Object.defineProperty(e,"__esModule",{value:!0}),e.routerConfig=n},function(t,e){"use strict";function n(t,e,n,a,o,r,s,l){"ngInject";if(t.globals=e.getObject("globals")||{},t.globals.currentUser){var c=t.globals.currentUser.token,d=l.parseJwt(c);i(d.exp)?(l.clearToken(),l.refreshToken(c)):n.defaults.headers.common.Authorization="JWT "+c}var u=t.$on("$locationChangeStart",function(){var e=["/"],n=-1==e.indexOf(o.path()),i=t.globals.currentUser;n&&!i?o.path("/"):"/"==o.path()&&i&&o.path("/dashboard")});t.$on("$destroy",u),s.locale("pt-br"),r.debug("runBlock end")}n.$inject=["$rootScope","$cookies","$http","$window","$location","$log","moment","authenticationService"],Object.defineProperty(e,"__esModule",{value:!0}),e.runBlock=n;var i=function(t){return Math.round((new Date).getTime()/1e3)>t}},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.LoginController=function(){function t(e,i,a,o,r,s){"ngInject";n(this,t),this.$http=e,this.$log=i,this.$rootScope=a,this.$location=o,this.$mdToast=r,this.authenticationService=s,this.username="",this.password="",a.globals.currentUser&&this.$location.path("/dashboard")}return t.$inject=["$http","$log","$rootScope","$location","$mdToast","authenticationService"],i(t,[{key:"login",value:function(){var t=this;this.username&&this.password&&this.authenticationService.login(this.username,this.password).then(function(){t.$rootScope.globals.currentUser?(t.$mdToast.show(t.$mdToast.simple().textContent("Usuário conectado com sucesso.").position("top right").hideDelay(3e3)),t.$location.path("/dashboard")):t.$mdToast.show(t.$mdToast.simple().textContent("Usuário e senha informados não foram reconhecidos.").position("top right").hideDelay(3e3))})}}]),t}()},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.DashboardController=function(){function t(e,i,a,o,r,s,l,c,d,u,m,h,p){"ngInject";var f=this;n(this,t),this.$location=a,this.$mdToast=r,this.$log=o,this.moment=s,this.Paho=l,this.store=c,this.authenticationService=m,this.apiClientService=h,this.mqttClientService=p,this.$timeout=d,this.$interval=u,this.lastUpdated=c.get("lastUpdated")||s(),this.user=e.globals.currentUser,this.isAsking=!1,this.isActivate=!1,this.block={percent:60,since:s(),onInterval:!1,lastUpdated:s()},this.cisterns=[{upperLevel:!1,lowerLevel:!0},{upperLevel:!1,lowerLevel:!0}],this.dryWell=!1,this.temperature=27,this.mode=1,this.blockWaterInterval,this.client=new l.MQTT.Client(p.server,p.port,p.clientId),this.client.onConnectionLost=this.onConnectionLost.bind(this),this.client.onMessageArrived=this.onMessageArrived.bind(this),this.initialize(),this.reconnect(),i.$on("$destroy",function(){f.blockWaterInterval.forEach(function(t){f.$interval.cancel(t)})})}return t.$inject=["$rootScope","$scope","$location","$log","$mdToast","moment","Paho","store","$timeout","$interval","authenticationService","apiClientService","mqttClientService"],i(t,[{key:"initialize",value:function(){this.handleBlockWater(),this.handleBlockWaterLater()}},{key:"getLastInformation",value:function(){}},{key:"getLastInformationLater",value:function(){var t=this;this.$timeout(function(){t.getLastInformation(),t.getLastInformationLater()},5e3)}},{key:"reconnect",value:function(){this.client.connect({userName:this.mqttClientService.username,password:this.mqttClientService.password,onSuccess:this.onConnect.bind(this),onFailure:this.reconnectLater.bind(this)})}},{key:"reconnectLater",value:function(){var t=this;this.reconnectAttemptTimeout&&this.$timeout.cancel(this.reconnectAttemptTimeout),this.reconnectAttemptTimeout=this.$timeout(function(){t.reconnect()},5e3)}},{key:"onConnect",value:function(){this.client.subscribe("i/"+this.mqttClientService.hub),this.client.subscribe("i/"+this.mqttClientService.hub+"/+"),this.client.subscribe("i/"+this.mqttClientService.hub+"/+/+")}},{key:"onConnectionLost",value:function(t){0!==t.errorCode&&this.reconnectLater()}},{key:"onMessageArrived",value:function(t){this.lastUpdated=this.moment(),this.store.set("lastUpdated",this.lastUpdated);var e=t.destinationName.split("/"),n=t.payloadString.split(",");if(4===e.length)if(55===Number(e[2]))2===Number(e[3])&&1===Number(n[0])&&(this.temperature=parseInt(n[1]));else if(105===Number(e[2]))if(0===Number(e[3]))3===Number(n[0])&&(this.isActivate=1===Number(n[1]));else if(1===Number(e[3]))switch(Number(n[0])){case 1:this.cisterns[0].lowerLevel=1===Number(n[1]);break;case 2:this.cisterns[1].lowerLevel=1===Number(n[1]);break;case 3:var i=1===Number(n[1]);this.isAsking!==i&&(this.block.lastUpdated=this.moment(),this.isAsking===!0&&i===!1&&this.handleBlockWaterUpTo()),this.isAsking=i,this.isAsking&&(this.block.since=this.moment());break;case 4:this.cisterns[0].upperLevel=1===Number(n[1]);break;case 5:this.cisterns[1].upperLevel=1===Number(n[1]);break;case 6:this.dryWell=1===Number(n[1]);break;case 7:1===Number(n[1])&&(this.mode=1);break;case 8:1===Number(n[1])&&(this.mode=2)}}},{key:"handleBlockWater",value:function(){this.isAsking&&!this.isActivate?(this.block.percent=20-(this.moment().unix()-this.block.since.unix())/750,this.block.percent<0&&(this.block.percent=3)):this.block.onInterval||(this.block.percent=this.block.percent-(this.moment().unix()-this.block.lastUpdated.unix())/750,this.block.percent<20&&(this.block.percent=20))}},{key:"handleBlockWaterUpTo",value:function(t){var e=this,n=t||80;angular.isDefined(this.blockWaterInterval)&&(this.$interval.cancel(this.blockWaterInterval),this.blockWaterInterval=void 0),this.blockWaterInterval=this.$interval(function(){e.block.onInterval=!0,e.block.percent++,e.block.percent>=n&&(e.block.percent=n,e.$interval.cancel(e.blockWaterInterval),e.block.onInterval=!1)},50)}},{key:"handleBlockWaterLater",value:function(){var t=this;angular.isDefined(this.blockWaterTimeout)&&(this.$timeout.cancel(this.blockWaterTimeout),this.blockWaterTimeout=void 0),this.blockWaterTimeout=this.$timeout(function(){t.handleBlockWater(),t.handleBlockWaterLater()},1e4)}},{key:"logout",value:function(){this.authenticationService.clearToken(),this.$mdToast.show(this.$mdToast.simple().textContent("Usuário desconectado.").position("top right").hideDelay(3e3)),this.$location.path("/")}}]),t}()},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.AuthenticationService=function(){function t(e,i,a,o,r){"ngInject";n(this,t),this.$http=e,this.$log=i,this.$window=a,this.$cookies=o,this.$rootScope=r,this.apiHost="https://api.integrada.ind.br/api"}return t.$inject=["$http","$log","$window","$cookies","$rootScope"],i(t,[{key:"login",value:function(t,e){var n=this;return this.clearToken(),this.$http.post(this.apiHost+"/auth/token/",{username:t,password:e}).then(function(t){return n.setToken(t.data.token),t.data})["catch"](function(t){return n.$log.error("XHR Failed for login.\n"+angular.toJson(t.data,!0)),t})}},{key:"setToken",value:function(t){var e=this.parseJwt(t);this.$rootScope.globals={currentUser:{username:e.username,is_staff:e.is_staff,token:t}},this.$http.defaults.headers.common.Authorization="JWT "+t,this.$cookies.putObject("globals",this.$rootScope.globals)}},{key:"refreshToken",value:function(t){var e=this;this.$http.post(this.apiHost+"/auth/token/refresh/",{token:t}).then(function(t){e.setToken(t.data.token)})}},{key:"clearToken",value:function(){this.$rootScope.globals={},this.$http.defaults.headers.common.Authorization="",this.$cookies.remove("globals")}},{key:"parseJwt",value:function(t){var e=t.split(".")[1],n=e.replace("-","+").replace("_","/");return angular.fromJson(this.$window.atob(n))}}]),t}()},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});e.MqttClientService=["moment",function i(t){"ngInject";n(this,i),this.server="broker.integrada.ind.br",this.port=9883,this.clientId="perola_"+t().unix(),this.hub="perola",this.username="integrada",this.password="integrada"}]},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.ApiClientService=function(){function t(e,i,a,o){"ngInject";n(this,t),this.$q=a,this.$http=e,this.$log=i,this.store=o,this.apiHost="https://api.integrada.ind.br/api/iot",this.limit=12}return t.$inject=["$http","$log","$q","store"],i(t,[{key:"getLastInformationIdentifier",value:function(t,e){var n=this;return this.$http.get(this.apiHost+"/information_updates/?information="+e).then(function(t){return{results:t.data.results}})["catch"](function(t){return n.$log.error("XHR Failed for getLastInformationIdentifier.\n"+angular.toJson(t.data,!0)),t})}}]),t}()},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.momentFormat=function(){return function(t,e){return t=t||moment(),e=e||"LLL",moment(t).format(e)}}},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(){"ngInject";var t={restrict:"E",templateUrl:"app/components/momentFrom/momentFrom.html",scope:{datetime:"="},controller:o,controllerAs:"momentFromCtrl",bindToController:!0};return t}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.MomentFromDirective=i;var o=function(){function t(e,i,a){"ngInject";var o=this;n(this,t),this.$timeout=e,this.moment=a,this.interval=1e4,this.value="",this.updateTime(),this.updateLater(),i.$on("$destroy",function(){angular.isDefined(o.timeoutId)&&(e.cancel(o.timeoutId),o.timeoutId=void 0)})}return t.$inject=["$timeout","$scope","moment"],a(t,[{key:"updateTime",value:function(){this.value=this.moment(this.datetime).fromNow()}},{key:"updateLater",value:function(){var t=this;this.timeoutId=this.$timeout(function(){t.updateTime(),t.updateLater()},this.interval)}}]),t}()}]),angular.module("intSmaPerolaDashboard").run(["$templateCache",function(t){t.put("app/dashboard/dashboard.html","<svg version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink x=0px y=0px style=\"display: none\"><symbol id=wave><path d=M420,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C514,6.5,518,4.7,528.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H420z></path><path d=M420,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C326,6.5,322,4.7,311.5,2.7C304.3,1.4,293.6-0.1,280,0c0,0,0,0,0,0v20H420z></path><path d=M140,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C234,6.5,238,4.7,248.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H140z></path><path d=M140,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C46,6.5,42,4.7,31.5,2.7C24.3,1.4,13.6-0.1,0,0c0,0,0,0,0,0l0,20H140z></path></symbol></svg><md-toolbar class=md-hue-2><div class=md-toolbar-tools><h2><span>Integrada <span hide show-gt-md>- Sistema Mais Água</span></span><br><small>Pérola do Atlântico</small></h2><span flex></span> <small hide show-gt-xs><span><md-tooltip>{{dashboardCtrl.lastUpdated | momentFormat}}</md-tooltip>Última atualização:&nbsp;<moment-from datetime=dashboardCtrl.lastUpdated></moment-from></span></small><md-button aria-label=Sair ng-click=dashboardCtrl.logout()>Sair</md-button></div></md-toolbar><md-content><md-content class=md-padding layout-gt-xs=row layout=column><div flex-xs flex-gt-xs=40 layout=column><md-card><md-card-title><md-card-title-text><span class=md-headline>Torre</span> <span class=md-subhead>{{dashboardCtrl.isAsking ? dashboard.isActivate ? 'Reservatório sendo abastecido' : 'Reservatório solicitando' : 'Reservatório abastecido'}}</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title><md-card-content layout=row layout-align=space-between><div class=box><div class=water style=\"transform: translate(0, {{100 - dashboardCtrl.block.percent}}%)\"><svg viewBox=\"0 0 560 20\" class=\"water_wave water_wave_back\"><use xlink:href=#wave></use></svg> <svg viewBox=\"0 0 560 20\" class=\"water_wave water_wave_front\"><use xlink:href=#wave></use></svg></div></div></md-card-content></md-card></div><div flex-xs flex-gt-xs=30 layout=column><md-card><md-card-title><md-card-title-text><span class=md-headline>Cisterna 1</span> <span class=md-subhead>{{dashboardCtrl.cisterns[0].upperLevel ? 'Cisterna em nível alto (verificar boia mecânica)' : (dashboardCtrl.cisterns[0].lowerLevel ? 'Cisterna normal' : 'Cisterna em nível baixo (verificar fornecimento de água)')}}</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title></md-card><md-card><md-card-title><md-card-title-text><span class=md-headline>Cisterna 2</span> <span class=md-subhead>{{dashboardCtrl.cisterns[1].upperLevel ? 'Cisterna em nível alto (verificar boia mecânica)' : (dashboardCtrl.cisterns[1].lowerLevel ? 'Cisterna normal' : 'Cisterna em nível baixo (verificar fornecimento de água)')}}</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title></md-card><md-card><md-card-title><md-card-title-text><span class=md-headline>Poço Seco</span> <span class=md-subhead>{{dashboardCtrl.dryWell === false ? 'Em segurança' : 'Risco de inundação'}}</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title></md-card></div><div flex-xs flex-gt-xs=30 layout=column><md-card><md-card-title><md-card-title-text><span class=md-headline>Temperatura</span> <span class=md-subhead>{{dashboardCtrl.temperature}}°C</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title></md-card><md-card><md-card-title><md-card-title-text><span class=md-headline>Modo de Operação</span> <span class=md-subhead>{{dashboardCtrl.mode === 1 ? 'Automático' : 'Manual'}}</span></md-card-title-text><md-card-title-media></md-card-title-media></md-card-title></md-card></div></md-content><md-content class=footer layout-padding layout-align=\"center center\"><h5>&copy; 2016 Integrada <small class=md-accent>*Os níveis são apenas ilustrativos.</small></h5></md-content></md-content>"),t.put("app/login/login.html",'<md-content layout=row layout-fill layout-align="center start" ng-cloak><section flex-gt-lg=20 flex-gt-md=30 flex-gt-xs=50 flex=100 class="jumbotron login"><h1><img class=logo ng-src=assets/images/logo.png alt=Integrada></h1><p>Pérola do Atlântico</p><form name=loginForm ng-submit=loginCtrl.login()><md-input-container class=md-block><label>Usuário</label><input name=username ng-model=loginCtrl.username type=text autofocus required><div ng-messages=loginForm.username.$error><div ng-message=required>Você precisa se identificar.</div></div></md-input-container><md-input-container class=md-block><label>Senha</label><input name=password ng-model=loginCtrl.password type=password required><div ng-messages=loginForm.password.$error><div ng-message=required>Não esqueça sua senha.</div></div></md-input-container><md-button type=submit class="md-raised md-primary pull-right">Entrar</md-button></form></section></md-content>'),t.put("app/components/momentFrom/momentFrom.html","<time datetime={{momentFromCtrl.datetime}}>{{momentFromCtrl.value}}</time>")}]);
//# sourceMappingURL=../maps/scripts/app-84b3f60e13.js.map
